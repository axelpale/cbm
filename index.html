<!DOCTYPE html>
<html>
<style type="text/css">
    body {       
        font-size: 20px;
    }

    #title {
        text-align: center;
        margin-bottom: 50px;
    }

    .button {
        font-size: 20px;
        padding: 15px 32px;
    }

    #wrapper {
        padding: 20px 50px 150px 50px;
        margin: 50px 100px;
        border: 2px solid black;
    }
</style>
<head>
    <title>CBM</title>
</head>
<body>
    <div id="wrapper">
        <div id="title">
            Select nice picture.
        </div>

        <div id="body" align=center>
            <p id="img"></p>
            <p id="clock">Time elapsed: </p>
            <p id="correct">Correct guesses: 0/0</p>
            <p id="ratio">Ratio: Nan</p>

            <form name="option_form" method="post">
            <input class="imgbutton" type="button" value="-">
            Images
            <input class="imgbutton" type="button" value="+">
            <br>
            <input class="sizebutton" type="button" value="-">
            Imagesize
            <input class="sizebutton" type="button" value="+">
            </form>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="data.json"></script>

<script type="text/javascript">
(function () { //closure
    // code
    const default_imagecount = 4
    const default_height = 150
    var imagecount = default_imagecount
    var height = default_height
    
    $('.imgbutton').click(function validateForm() {
        // image count buttons pressed

        var type = $(this).attr("value")
        var newcount = imagecount
        if (type == "+") {
            newcount += 1 
        } else {
            newcount -= 1 
        }
        
        if (newcount > 1 && newcount < 6) {
            imagecount = newcount;
            drawImages();
        }
    });

    $('.sizebutton').click(function validateForm() {
        // image size buttons pressed

        var type = $(this).attr("value")
        var newsize = height
        if (type == "+") {
            newsize += 10
        } else {
            newsize -= 10
        }
        
        if (newsize > 99 && newsize < 301) {
            height = newsize;
            drawImages();
        }
    });

    // url_happy & url_unhappy are stored in a json file under a variable "data".
    // data contains a dict that contains two words that separate url lists.
    // Url-lists are such as: ["url1.jpg", "url2.jpg", ...]
    // TODO: figure out open-source-sources to fill them automatically
   
    var timepassed = 0
    var correctguess = 0
    var totalguess = 0    

    setInterval(function() {myTimer()}, 1000);
    drawImages();

    function drawImages(){
        // jquery
        url_happy = data["url_happy"];
        url_unhappy = data["url_unhappy"];

        numhappy = url_happy.length;
        numunhappy = url_unhappy.length;

        var happyrow = Math.floor(Math.random() * imagecount); 
        var happycol = Math.floor(Math.random() * imagecount);

        var imagepath = "";
        var happyindex, imgrow, img, imgel;
        $('#img').empty();
        for (j = 0; j < imagecount; j++) {
            imgrow = $('<div class="imgrow"></div>');
            for (i = 0; i < imagecount; i++) {
                if (i==happyrow && j==happycol) {
                    happyindex = Math.floor(Math.random() * numhappy);
                    img = url_happy[happyindex];
                    imgel = $("<img height=" + height + " src='" + img + "'>"); //width=" + 0.75*height +"
                    imgel.click(function () {
                        processResult(true);
                    });
                }
                else {
                    unhappyindex = Math.floor(Math.random() * numunhappy)
                    img = url_unhappy[unhappyindex];
                    imgel = $("<img height=" + height + "  src='" + img + "'>");
                    imgel.click(function () {
                        processResult(false);
                    });
                }
                imgrow.append(imgel);
            }
            $('#img').append(imgrow);
        }
    }

    function processResult(correct){
        totalguess +=1;

        if (correct){
            correctguess = correctguess + 1;
        } else {
            alert("Incorrect!");
        }
        document.getElementById("correct").innerHTML = "Correct: " + correctguess + "/" + totalguess;
        document.getElementById("ratio").innerHTML = "Ratio: " + Math.round(correctguess*100/(totalguess)) + "%";
        drawImages();
    }

    function myTimer() {
        timepassed = timepassed + 1;
        document.getElementById("clock").innerHTML = "Time elapsed: " + timepassed;
    }

    // TODO: fix this function to opt out of js-script data-loading
    function loadData(filename) {
        fr = new FileReader();
        fr.onload = (function receivedText(e) {
            let lines = e.target.result;
            var newArr = JSON.parse(lines);
        });
        fr.readAsText(filename);
        return JSON.parse(xmlHttp.responseText);
    }
}());
</script>
</body>
</html>