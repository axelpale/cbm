<!DOCTYPE html>
<html>
<style type="text/css">
    body {
        font-size: 20px;
    }

    #title {
        text-align: center;
        font-size: 30px;
        margin-bottom: 30px;
    }

    .imgbutton, .sizebutton {
        font-size: 27px;
    }

    #wrapper {
        padding: 20px 50px 30px 50px;
        margin: 30px 70px;
        border: 2px solid black;
    }
</style>
<head>
    <title>CBM</title>
</head>
<body>
    <div id="wrapper">
        <div id="title">
            Find a nice emotion.
        </div>
        <div id="body" align=center>
            <form name="option_form" method="post">
            <table><tr><td>
                <input class="imgbutton" type="button" value="-">
                </td><td>
                Images
            </td><td>
                <input class="imgbutton" type="button" value="+">
            </td><td id="empty">
            </td><td>
                <input class="sizebutton" type="button" value="-">
            </td><td>
            </td><td>
                Imagesize
            </td><td>
                <input class="sizebutton" type="button" value="+">
            </td>
            </tr>
            </table>
            </form>
            <br>
            <p id="img"></p>
            <p id="clock">Time: </p>
            <p id="correct">Correct guesses: 0/0</p>
            <p id="ratio">Ratio: Nan</p>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="data.json"></script>

<script type="text/javascript">
(function () { //closure
    // code
    const default_imagecount = 4
    const default_height = 150
    var imagecount = default_imagecount
    var height = default_height

    // set space between buttons
    $("#empty").width("15px")

    $('.imgbutton').click(function validateForm() {
        // image count buttons pressed

        var type = $(this).attr("value")
        var newcount = imagecount
        if (type == "+") {
            newcount += 1;
        } else {
            newcount -= 1;
        }

        if (newcount > 1 && newcount < 6) {
            imagecount = newcount;
            drawImages();
        }
    });

    $('.sizebutton').click(function validateForm() {
        // image size buttons pressed

        var type = $(this).attr("value");
        var newsize = height;
        if (type == "+") {
            newsize += 10;
        } else {
            newsize -= 10;
        }

        if (newsize > 99 && newsize < 301) {
            // this is made easy by jquery (updated)
            height = newsize;
            $(".images").height(newsize);
        }
    });

    // url_happy & url_unhappy are stored in a json file under a variable "data".
    // data contains a dict that contains two words that separate url lists.
    // Url-lists are such as: ["url1.jpg", "url2.jpg", ...]
    // TODO: figure out open-source-sources to fill them automatically

    var timepassed = 0
    var correctguess = 0
    var totalguess = 0

    setInterval(function() {myTimer()}, 1000);
    drawImages();

    function drawImages(){
        // jquery
        url_happy = data["url_happy"];
        url_unhappy = data["url_unhappy"];

        numhappy = url_happy.length;
        numunhappy = url_unhappy.length;

        var happyrow = Math.floor(Math.random() * imagecount);
        var happycol = Math.floor(Math.random() * imagecount);

        var imagepath = "";
        var happyindex, imtable, imgrow, img, imgel;
        $('#img').empty();
        imtable = $('<table id="imtable"></table>');
        for (j = 0; j < imagecount; j++) {
            imgrow = $('<tr></tr>');
            for (i = 0; i < imagecount; i++) {
                imgel = $("<td></td>");
                if (i==happyrow && j==happycol) {
                    happyindex = Math.floor(Math.random() * numhappy);
                    img = url_happy[happyindex];
                    imgel.append("<img class=\"images\" height=" + height + " src='" + img + "'>"); //width=" + 0.75*height +"
                    imgel.click(function () {
                        processResult(true);
                    });
                }
                else {
                    unhappyindex = Math.floor(Math.random() * numunhappy)
                    img = url_unhappy[unhappyindex];
                    imgel.append("<img class=\"images\" height=" + height + "  src='" + img + "'>");
                    imgel.click(function () {
                        processResult(false);
                    });
                }
                imgrow.append(imgel);
            }
            imtable.append(imgrow);
        }
        $('#img').append(imtable);
    }

    function processResult(correct){
        totalguess +=1;

        if (correct){
            correctguess = correctguess + 1;
            drawImages();
        } else {
            //alert("Incorrect!");
            $("#imtable").css('background-color', 'red');
            $(".images").css('opacity', 0.5);
            setTimeout(function () {
                $(".images").css('opacity', 1);
                $("#imtable").css('background-color', 'white');}, 500);
        }
        document.getElementById("correct").innerHTML = "Correct: " + correctguess + "/" + totalguess;
        document.getElementById("ratio").innerHTML = "Ratio: " + Math.round(correctguess*100/(totalguess)) + "%";
    }

    function myTimer() {
        timepassed = timepassed + 1;
        document.getElementById("clock").innerHTML = "Time: " + timepassed;
    }

    // TODO: fix this function to opt out of js-script data-loading
    function loadData(filename) {
        fr = new FileReader();
        fr.onload = (function receivedText(e) {
            let lines = e.target.result;
            var newArr = JSON.parse(lines);
        });
        fr.readAsText(filename);
        return JSON.parse(xmlHttp.responseText);
    }
}());
</script>
</body>
</html>